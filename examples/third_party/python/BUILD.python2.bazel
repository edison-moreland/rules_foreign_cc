load("@rules_foreign_cc//foreign_cc:defs.bzl", "configure_make")
load("@bazel_skylib//lib:dicts.bzl", "dicts")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "all_srcs",
    srcs = glob(["**"]),
)

CONFIGURE_ENV_VARS = {
    "CFLAGS": "-Dredacted='\\\"redacted\\\"'",
    "CXXFLAGS": "-Dredacted='\\\"redacted\\\"'",
}

configure_make(
    name = "python2",
    configure_env_vars = select({
        "@platforms//os:macos": dicts.add({"AR": ""}, CONFIGURE_ENV_VARS),
        "//conditions:default": CONFIGURE_ENV_VARS,
    }),
    configure_options = [
        "--with-openssl=$EXT_BUILD_DEPS/openssl",
        "--with-zlib=$EXT_BUILD_DEPS/zlib",
    ],
    # rules_foreign_cc defaults the install_prefix to "python". This conflicts with the "python" executable that is generated.
    install_prefix = "py_install",
    lib_source = ":all_srcs",
    out_binaries = [
        "python2",
    ],
    out_data_dirs = ["lib"],
    tools_deps = select({
        "@platforms//os:macos": ["@subversion"],
        "//conditions:default": [],
    }),
    deps = [
        "@openssl",
        "@zlib",
    ],
)

filegroup(
    name = "python2_bin",
    srcs = [":python2"],
    output_group = "python2",
)
